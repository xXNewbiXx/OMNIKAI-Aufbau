name: ci
on:
  push:
  pull_request:

jobs:
  sanity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools (jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Sanity Check – Ordnerstruktur
        run: |
          echo "✅ CI läuft"
          test -d docs && echo "docs/ gefunden" || (echo "❌ docs/ fehlt" && exit 1)
          test -d prompts && echo "prompts/ gefunden" || echo "⚠️ prompts/ fehlt"
          test -d flows && echo "flows/ gefunden" || echo "⚠️ flows/ fehlt"

      - name: Validate README format
        run: |
          if grep -q "^# " README.md; then
            echo "✅ README hat Titel"
          else
            echo "❌ README hat keinen Titel" && exit 1
          fi

      - name: Validate JSON files in flows/
        run: |
          shopt -s nullglob
          for f in flows/**/*.json; do
            echo "Prüfe $f ..."
            cat "$f" | jq empty || exit 1
          done

  validate_sources:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure sources & schema exist
        run: |
          test -f datasources/sources.yaml || (echo "❌ datasources/sources.yaml fehlt" && exit 1)
          test -f schemas/sources.schema.json || (echo "❌ schemas/sources.schema.json fehlt" && exit 1)

      - name: Convert YAML to JSON
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml
          python - <<'PY'
          import json, yaml
          with open('datasources/sources.yaml','r', encoding='utf-8') as f:
              data = yaml.safe_load(f)
          with open('/tmp/sources.json','w', encoding='utf-8') as f:
              json.dump(data, f)
          print("OK: /tmp/sources.json geschrieben")
          PY

      - name: Install ajv
        run: npm i -g ajv-cli@5

      - name: AJV validate
        run: ajv validate -s schemas/sources.schema.json -d /tmp/sources.json --spec=draft7
