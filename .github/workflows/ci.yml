name: ci
on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write   # damit der Workflow ins Repo pushen darf

jobs:
  codex:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (mit GitHub-Token)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false   # wir setzen gleich eine eigene Remote mit Token

      - name: Git-IdentitÃ¤t + Remote (per GITHUB_TOKEN)
        run: |
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}"

      - name: Codex Auto-Cleanup (Demo: Heartbeat anlegen/anhÃ¤ngen)
        run: |
          mkdir -p logs
          echo "heartbeat $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> logs/ci_heartbeat.txt
          # ğŸ‘‰ HIER kannst du spÃ¤ter echte AufrÃ¤um-Aktionen reinschieben
          # z.B.: find . -name "*.tmp" -delete

      - name: Commit & Push
        run: |
          set -e
          git add -A
          git commit -m "codex: auto-maintenance heartbeat [skip ci]" || echo "nix zu committen"
          # zurÃ¼ck in denselben Branch pushen
          git push origin "HEAD:${GITHUB_REF#refs/heads/}"
