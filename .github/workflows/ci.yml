name: ci
on:
  push:
  pull_request:

jobs:
  sanity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Sanity Check – Ordnerstruktur
        run: |
          echo "✅ CI läuft"
          test -d docs && echo "docs/ gefunden" || (echo "❌ docs/ fehlt" && exit 1)
          test -d prompts && echo "prompts/ gefunden" || echo "⚠️ prompts/ fehlt"
          test -d flows && echo "flows/ gefunden" || echo "⚠️ flows/ fehlt"

      - name: Validate README format
        run: |
          if grep -q "^# " README.md; then
            echo "✅ README hat Titel"
          else
            echo "❌ README hat keinen Titel" && exit 1
          fi

      - name: Validate JSON files in flows/
        run: |
          shopt -s nullglob
          for f in flows/**/*.json; do
            echo "Prüfe $f ..."
            cat "$f" | jq empty || exit 1
          done
  validate_sources:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y jq yq
      - name: Validate sources.yaml schema
        run: |
          test -f datasources/sources.yaml || (echo "sources.yaml fehlt" && exit 1)
          yq -o=json '. ' datasources/sources.yaml > /tmp/sources.json
          echo '${{ toJson(matrix.ignore) }}' >/dev/null # noop to avoid interpolation warnings
          cat /tmp/sources.json | jq '.' >/dev/null
      - name: Download ajv
        run: |
          npm i -g ajv-cli@5
      - name: AJV validate
        run: |
          ajv validate -s schemas/sources.schema.json -d /tmp/sources.json --spec=draft7

      - name: Check Markdown files
        run: |
          find . -name "*.md" -print | while read file; do
            echo "Prüfe $file ..."
            head -n 1 "$file" >/dev/null || exit 1
          done
